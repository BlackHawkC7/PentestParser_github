#include "pentoolnmap.h"

PenToolNmap::PenToolNmap()
{
    connect(&process, SIGNAL(finished(int, QProcess::ExitStatus)), this, SLOT(processFinished(int, QProcess::ExitStatus)));
    connect(&process, SIGNAL(stateChanged(QProcess::ProcessState)), this, SLOT(processStatusChanged(QProcess::ProcessState)));
    //connect(&process, SIGNAL(readyReadStandardOutput()), this, SLOT(processReadyToRead()));
    connect(&process, SIGNAL(errorOccurred(QProcess::ProcessError)), this, SLOT(processError(QProcess::ProcessError)));

    //connect(&this->process, &QProcess::finished(int, QProcess::ExitStatus), this, &PenToolNmap::processFinished(int, QProcess::ExitStatus));
    //connect(&this->process, &QProcess::stateChanged, this, &PenToolNmap::processStatusChanged);
    //connect(&process, static_cast<void(QProcess::*)(int, QProcess::ExitStatus)>(QProcess::finished), this, &PenToolNmap::processFinished);
}

PenToolNmap::PenToolNmap(QString filePath)
{
    QFile f(filePath);
    if(!f.open(QIODevice::ReadOnly)) {
        qDebug() << "error loading file";
    }
    this->xmlFile.setContent(&f);
    f.close();
}

void PenToolNmap::parse()
{
    QDomElement root = this->xmlFile.documentElement();

    //QString startTime = root.attribute("start");
    QDateTime startTimestamp;
    startTimestamp.setTime_t(root.attribute("start").toUInt());
    QDateTime stopTimestamp;
    stopTimestamp.setTime_t(root.elementsByTagName("runstats").at(0).toElement().elementsByTagName("finished").at(0).toElement().attribute("time").toUInt());

    //TODO - nefunguje konverze do QTime, QDateTime...
    qint64 rozdil = startTimestamp.secsTo(stopTimestamp);
    QTime duration(0,0,0);
    duration.addSecs((int)rozdil);

    qDebug() << "duration: " << duration;

    QString version = root.attribute("version");
    QString atributes = root.attribute("args");

    //nmapdone message
    QDomElement output = root.elementsByTagName("output").at(0).toElement();
    QString doneMessage = output.text().mid(output.text().indexOf("Nmap done:"), -1).simplified();

    qDebug() << doneMessage;

    //HOSTS list
    QDomNodeList hostList = root.elementsByTagName("host");
    qDebug() << "numberOfItemsInList: " << hostList.size();

    //hosts
    for(int i=0; i<hostList.size(); i++) {
        QDomElement hostElement = hostList.at(i).toElement();

        QString hostIpAddress = hostElement.elementsByTagName("address").at(0).toElement().attribute("addr");

        QDomNodeList portList = hostElement.elementsByTagName("port");

        //host ports
        for(int j=0; j<portList.size(); j++) {
            QDomElement portElement = portList.at(j).toElement().elementsByTagName("service").at(0).toElement();

            int portNumber = portList.at(j).toElement().attribute("portid").toInt();
            QString portService = portElement.attribute("product");
            QString portServiceName = portElement.attribute("name");
            QString portServiceVersion = portElement.attribute("version");
        }

        //host OS
        QDomNodeList osList = hostElement.elementsByTagName("os");
        QDomNodeList osmatchList = osList.at(0).toElement().elementsByTagName("osmatch");

        for(int j=0; j<osmatchList.size(); j++) {
            QDomElement osmatchElement = osmatchList.at(j).toElement();

            QString osName = osmatchElement.attribute("name");
            int osAccuracy = osmatchElement.attribute("accuracy").toInt();

            QDomElement osClass = osmatchElement.elementsByTagName("osclass").at(0).toElement();

            //musi si malanik vybrat...
            QString osType = osClass.attribute("type");
            QString osFamily = osClass.attribute("osfamily");
            QString osVendor = osClass.attribute("vendor");
            QString osGen = osClass.attribute("osgen");
        }

        //TODO - tcpsequence atd...
        /*
        code
        */

        //tracert
        QDomElement traceElement = hostElement.elementsByTagName("trace").at(0).toElement();
        QDomNodeList hopList = traceElement.elementsByTagName("hop");

        int networkDistance = hopList.size();
        for(int j=0; j<hopList.size(); j++) {
            QDomElement hop = hopList.at(j).toElement();

            double rtt = hop.attribute("rtt").toDouble();
            QString ipAddress = hop.attribute("ipaddr");
        }
    }
}

void PenToolNmap::run()
{
    //nmap [ <Scan Type> ...] [ <Options> ] { <target specification> }

    QString scanType = " -A";
    QString options = " -p 1-100";
    QString targetSpecification = " 192.168.1.1";

    QString nmapDirectory = QCoreApplication::applicationDirPath()+"/nmap/";


    //this->process.setWorkingDirectory(nmapDirectory);


    qDebug() << "directory: " << nmapDirectory;
    qDebug() << "work dir:  " << process.workingDirectory();

    QFileInfo checkFile(nmapDirectory + "7za.exe");
    qDebug() << "exist: " << checkFile.exists();

    //process.setWorkingDirectory()
    qDebug() << "starting nmap...";

    this->process.start(nmapDirectory + "nmap.exe" + scanType + options + targetSpecification);

    //this->process.waitForStarted();
    //this->process.waitForFinished();

    //process.execute("nmap.exe");
    qDebug() << "end..";
}


void PenToolNmap::processReadyToRead()
{
    qDebug() << "ready to read";
    QStringList result;
    result << this->process.readAllStandardOutput();

    qDebug() << result;
}

void PenToolNmap::processStatusChanged(QProcess::ProcessState state)
{
    qDebug() << "status changed: " << state;
}

void PenToolNmap::processFinished(int exitCode, QProcess::ExitStatus exitStatus)
{
    qDebug() << "finished";
    qDebug() << "\tCode: " << exitCode;
    qDebug() << "\tStatus: " << exitStatus;
    qDebug() << "\n\n\n\n\n";

    this->resultString = this->process.readAllStandardOutput();
    this->parse();
}

void PenToolNmap::processError(QProcess::ProcessError error)
{
    qDebug() << "ERROR !!!   " << error;
    qDebug() << "\t" << this->process.errorString();
}
