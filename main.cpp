#include <QCoreApplication>
#include <QDebug>
#include <QProcess>
#include <QCommandLineOption>
#include <QCommandLineParser>

#include "pentoolnmap.h"
#include "pentoolzap.h"
#include "pentoolsparta.h"

#include "pentoolconfig.h"

int main(int argc, char *argv[])
{
    QCoreApplication app(argc, argv);
    QCoreApplication::setApplicationName("PentestParses");
    QCoreApplication::setApplicationVersion("0.8");

    QCommandLineParser cliParser;
    cliParser.addHelpOption();
    cliParser.addVersionOption();
    cliParser.setApplicationDescription("Application for parsing pentest tools outputs.\n"
                                        "First you must select operation which you want to use, parse or run.\n"
                                        "Then you must select pentest tool.");

    QCommandLineOption runOption(QStringList() << "r" << "run","runs selected tool a generate output");
    QCommandLineOption parseOption(QStringList() << "p" << "parse", "parse selected tool file");

    QCommandLineOption nmapOption("nmap", "selects nMap tool, supported functions: run, parse");
    QCommandLineOption zapOption("zap", "selects ZAP tool, supported funtions: parse");
    QCommandLineOption spartaOption("sparta", "selects Sparta tool, supported funtions: parse");

    QCommandLineOption inputFileOption(QStringList() << "i" << "input-file", "sets the input file path, only for parsing", "file");
    QCommandLineOption xmlOption(QStringList() << "X" << "xml", "sets XML as output format");
    QCommandLineOption jsonOption(QStringList() << "J" << "json", "sets JSON as output format");


    cliParser.addOptions({runOption, parseOption});
    cliParser.addOptions({inputFileOption ,xmlOption, jsonOption});
    cliParser.addOptions({nmapOption, zapOption, spartaOption});
    cliParser.process(app);


    QString outputFileFormat;
    if(cliParser.isSet(xmlOption))
        outputFileFormat = "xml";
    else if(cliParser.isSet(jsonOption))
        outputFileFormat = "json";
    else {
        qInfo() << "ERROR: no output file format selected";
        cliParser.showHelp();
    }

    if(cliParser.isSet(runOption)) {
        //run
        if(cliParser.isSet(nmapOption)) {
            //TODO - nmap run
        }
        else cliParser.showHelp();
    }

    else if(cliParser.isSet(parseOption)) {
        //parse
        if(cliParser.isSet(nmapOption)) {
            //nmap
            if(!cliParser.isSet(inputFileOption)) {
                qInfo() << "ERROR: no input file";
                cliParser.showHelp();
            }
            else {
                PenToolNmap nmap(cliParser.value(inputFileOption));
                nmap.parse(outputFileFormat);
                return 0;
            }
        }
        else if(cliParser.isSet(zapOption)) {
            //zap
            if(!cliParser.isSet(inputFileOption)) {
                qInfo() << "ERROR: no input file";
                cliParser.showHelp();
            }
            else {
                PenToolZap zap(cliParser.value(inputFileOption));
                zap.parse(outputFileFormat);
                return 0;
            }
        }
        else if(cliParser.isSet(spartaOption)) {
            //sparta
            if(!cliParser.isSet(inputFileOption)) {
                qInfo() << "ERROR: no input file";
                cliParser.showHelp();
            }
            else {
                PenToolSparta sparta(cliParser.value(inputFileOption));
                sparta.parse(outputFileFormat);
                return 0;
            }
        }
        else cliParser.showHelp();
    }
    else cliParser.showHelp();



    /*
    penToolConfig ptConfig("configTest.ini");

    PenToolNmap nmapTestConfig;
    nmapTestConfig.run(ptConfig.getNmapArguments());
    */




    //nmap testing
    /*
    PenToolNmap nmap("testSCAN.xml");
    PenToolNmap nmap("result.xml");
    nmap.parse();*/

    //zap testing
    /*
    PenToolZap zaptool("report.xml");
    zaptool.parse();*/

    //sparta testing
    /*
    PenToolSparta spartaTool("target01.sprt");
    spartaTool.parse();*/


    //return a.exec();
}
