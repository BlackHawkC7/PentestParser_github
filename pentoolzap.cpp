#include "pentoolzap.h"

PenToolZap::PenToolZap()
{

}

PenToolZap::PenToolZap(QString filePath)
{
    QFile f(filePath);
    if(!f.open(QIODevice::ReadOnly)) {
        qInfo() << "ERROR: loading input file failed";
    }
    this->xmlFile.setContent(&f);
    f.close();
}

void PenToolZap::parse(QString resultFileFormat)
{
    if(xmlFile.isNull()) {
        qInfo() << "ERROR: loading xml failed";
        return;
    }
    QDomElement root = this->xmlFile.documentElement();
    result.date = root.attribute("generated");

    QDomNodeList sitesElements = root.elementsByTagName("site");

    QList<site> siteList;
    for(int i=0; i<sitesElements.size(); i++) {
        QDomElement siteElement = sitesElements.at(i).toElement();
        site newSite;

        newSite.url = siteElement.attribute("name");
        newSite.host = siteElement.attribute("host");
        newSite.port = siteElement.attribute("port").toUInt();

        QDomNodeList alertsElements = siteElement.elementsByTagName("alertitem");

        QList<alert> alertList;
        for(int j=0; j<alertsElements.size(); j++) {
            QDomElement alertElement = alertsElements.at(j).toElement();
            alert newAlert;

            newAlert.name = alertElement.elementsByTagName("alert").at(0).toElement().text();
            newAlert.description = alertElement.elementsByTagName("desc").at(0).toElement().text();
            newAlert.parameter = alertElement.elementsByTagName("param").at(0).toElement().text();
            newAlert.solution = alertElement.elementsByTagName("solution").at(0).toElement().text();
            newAlert.reference = alertElement.elementsByTagName("reference").at(0).toElement().text();
            newAlert.cweId = alertElement.elementsByTagName("cweid").at(0).toElement().text().toUInt();

            newAlert.risk = alertElement.elementsByTagName("riskdesc").at(0).toElement().text().split(" ").at(0).toLower();
            newAlert.riskCode = alertElement.elementsByTagName("riskcode").at(0).toElement().text().toUInt();
            switch (newAlert.riskCode) {
            case 0:
                result.summary.informational++;
                break;
            case 1:
                result.summary.low++;
                break;
            case 2:
                result.summary.medium++;
                break;
            case 3:
                result.summary.high++;
                break;
            default:
                break;
            }

            alertList.append(newAlert);
        }
        newSite.alertList = alertList;
        siteList.append(newSite);
    }
    result.siteList = siteList;

    if(resultFileFormat == "xml")
        result.toXmlFile();
    else if(resultFileFormat == "json")
        result.toJsonFile();
}
